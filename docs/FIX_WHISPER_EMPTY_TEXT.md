# Исправление проблемы: Whisper не распознает текст (text_length=0)

## Проблема

Whisper работает (модель загружается, транскрипция выполняется), но результат всегда `text_length=0, words=0`.

## Причины

1. **Модель `tiny` слишком маленькая для русского языка** - это основная причина
2. Низкое качество аудио
3. Аудио слишком короткое или тихое

## Решение 1: Использовать более крупную модель Whisper (рекомендуется)

Модель `tiny` слишком слабая для русского языка. Рекомендуется использовать `base` или `small`:

### Вариант A: Модель `base` (хороший баланс скорости и точности)

```bash
# Обновите .env файл
nano .env

# Измените WHISPER_MODEL:
WHISPER_MODEL=base

# Перезапустите сервер
./stop_all.sh
./start_all.sh
```

### Вариант B: Модель `small` (лучшая точность, но медленнее)

```bash
# Обновите .env файл
nano .env

# Измените WHISPER_MODEL:
WHISPER_MODEL=small

# Перезапустите сервер
./stop_all.sh
./start_all.sh
```

**Примечание:** 
- `base` - хороший баланс (размер ~142MB)
- `small` - лучше для русского (размер ~466MB)
- `medium` - еще лучше, но медленнее (размер ~1.4GB)
- `large` - лучшая точность, но очень медленная (размер ~2.9GB)

## Решение 2: Проверить качество аудио

Если проблема сохраняется, проверьте качество аудио:

```bash
# Проверьте, что в аудио действительно есть речь
# Можно попробовать распознать тестовый файл вручную:

# Скачайте тестовый файл (если есть)
# Затем проверьте его через Whisper напрямую:
python -c "
import whisper
model = whisper.load_model('base')
result = model.transcribe('путь/к/файлу.wav', language='ru')
print(result['text'])
"
```

## Решение 3: Проверить настройки языка

Убедитесь, что язык указан правильно:

```bash
cat .env | grep ASR_LANGUAGE
```

Должно быть: `ASR_LANGUAGE=ru-RU`

## Быстрая проверка после изменения

После обновления модели:

1. **Перезапустите сервер:**
   ```bash
   ./stop_all.sh
   ./start_all.sh
   ```

2. **Отправьте тестовое голосовое сообщение боту**

3. **Проверьте логи:**
   ```bash
   tail -f server.log | grep -i whisper
   ```

4. **Ищите в логах:**
   - `Loading Whisper model: base` (или `small`)
   - `Whisper transcription completed: text_length=...` (должно быть > 0)
   - `ASR result: text_length=..., words=...` (должно быть > 0)

## Рекомендуемая конфигурация для русского языка

```bash
ASR_BACKEND=whisper
ASR_LANGUAGE=ru-RU
WHISPER_MODEL=base  # или small для лучшей точности
```
