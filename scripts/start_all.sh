#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–æ—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

set -e

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT"

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -d ".venv" ]; then
    source .venv/bin/activate
else
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./scripts/deploy.sh"
    exit 1
fi

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f ".env" ]; then
    export $(cat .env | grep -v '^#' | xargs)
else
    echo "‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–æ—Ç–∞..."

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ–Ω–µ
echo "üì° –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
nohup uvicorn server.main:app --host 0.0.0.0 --port ${PORT:-8001} --log-level ${LOG_LEVEL:-info} > server.log 2>&1 &
SERVER_PID=$!
echo "   –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $SERVER_PID)"

# –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $SERVER_PID 2>/dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ server.log"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ (–∫–∞–∫ –º–æ–¥—É–ª—å)
echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup python -m bot.bot > bot.log 2>&1 &
BOT_PID=$!
echo "   –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID –≤ —Ñ–∞–π–ª –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
echo $SERVER_PID > server.pid
echo $BOT_PID > bot.pid

echo ""
echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:"
echo "   tail -f server.log  # –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞"
echo "   tail -f bot.log    # –õ–æ–≥–∏ –±–æ—Ç–∞"
echo ""
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞:"
echo "   ./scripts/stop_all.sh  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞"
echo "   kill $SERVER_PID       # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä"
echo "   kill $BOT_PID          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞"
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
echo "   ps aux | grep uvicorn"
echo "   ps aux | grep bot.py"
